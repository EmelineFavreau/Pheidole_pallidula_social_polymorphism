# 2020-11-13
# Emeline Favreau, QMUL

# Pheidole pallidula
# 2019-03-15-map_reads_to_minion_flye
# Investigation of genomic regions with only M read mapping
# hypothesis: a unique M region is present and important in social polymorphism
# evidence required: a region with no P reads and all M reads



# create a tmp scratch
mkdir -p /data2/scratch/btx077/2019-03-05-association_analysis_flye_assembly/2019-03-15-map_reads_to_minion_flye

ln -s /data2/scratch/btx077/2019-03-05-association_analysis_flye_assembly/2019-03-15-map_reads_to_minion_flye tmp



# obtain input
cd input

ln -s ../../2019-03-14-bruniquel-maf10percent/input/*-P* .
ln -s ../../2019-03-14-bruniquel-maf10percent/input/*-M* .


# list of 73 P bams
ls -1 *-P*.bam | cut -d "." -f 1 > sample-list
wc -l sample-list

# list of 38 M bams
ls -1 *-M*.bam | cut -d "." -f 1 > M-sample-list
wc -l M-sample-list

cd ..

     


# create a bed file for each P sample, with regions of zero depth 
qsub make-zero-depth-P-bed.sh

# move one bam into a template folder
mkdir tmp/template-bam

mv tmp/A01-P_zero_coverage_regions.BED tmp/template-bam/.

# check that there are 72 files here
# ls tmp/*-P_zero_coverage_regions.BED | wc -l

# make a bed with all regions of zero coverage common to all P samples
qsub find-common-P-regions-zero-depth.sh

# this creates a large bed that is sorted and merged 
head tmp/P_zero_coverage_regions.merged.BED



# create a bed file for each M sample, with regions of non-zero depth
qsub make-non-zero-depth-M-bed.sh
cat make-non-zero-depth-M-bed.sh.*
rm -f make-non-zero-depth-M-bed.sh.*
ls tmp/*_non_zero_coverage_regions.BED

# move one bam into a template folder
mv tmp/A07-M_non_zero_coverage_regions.BED tmp/template-bam/.

# find common loci with some depth for all M samples
qsub find-common-M-regions-non-zero-depth-short-mem.sh

# this creates a large bed that is sorted and merged 2021/01/05 done
head tmp/M_non_zero_coverage_regions.merged.BED


# combine overlapping regions from P (with no coverage) and M (with some coverage)
# sort and merge the output bed
qsub find-unique-M-regions.sh

# there are 961563 instances of unique M regions
# wc -l tmp/unique_M_regions.merged.BED

# sort bed by chromosome and by feature size (in descending order)
qsub find-longest-unique-M-regions.sh
head tmp/contig-start-end-length.sorted.txt

# copy this sumamry table in result
cp tmp/contig-start-end-length.sorted.txt  result/.



# explore length distribution
Rscript 2021-01-07-investigation-M-regions.Rmd

# explore content of these regions:

# soft link genome assembly fasta
cd input
ln -s ~/db/genomic/Pheidole_pallidula/2019-03-05-Ppal_E/Ppal_E.fasta .
cd ..

# keep unique regions that are longer than 1000 (13 in total)
awk '$4 > 1000' tmp/contig-start-end-length.sorted.txt | cut -f 1-3 > tmp/longest_unique_M_regions.BED

# change the bed file to match assembly heading 
sed 's/_pilon_pilon_pilon_pilon_pilon_pilon_pilon_pilon_pilon_pilon//g' tmp/longest_unique_M_regions.BED > tmp/longest_unique_M_regions.shortname.BED

sed 's/contig_/Ppal_E.contig_/g' tmp/longest_unique_M_regions.shortname.BED > tmp/longest_unique_M_regions.Ppal_E.BED

# bedtools getfasta extracts sequences from the reference FASTA file 
# for each of the intervals defined in a BED file.

bedtools getfasta -fi input/Ppal_E.fasta \
                  -bed tmp/longest_unique_M_regions.Ppal_E.BED \
                  -fo result/longest_unique_M_regions.fasta

# copy the resulting fasta into blast nucleotide
# web blastn Highly similar sequences (megablast); against hymenoptera)
# only five regions have hits, the rest have none.
# I saved the resulting text file in result
head result/ZEGWCNG601R-Alignment.txt

# update summary result with BLAST result
vim result/contig-start-end-length.sorted.txt

# None of the hits are about social organisation/communication
# Vollenhovia emeryi kinase RNA 3e-104 89% identity
# Camponotus floridanus uncharacterised mRNA 4e-71 86% identity
# Monomorium protein protein ANTAGONIST OF LIKE HETEROCHROMATIN PROTEIN 1  mRNA 2e-33 93% identity
# Camponotus floridanus protein ALP1-like mRNA 4e-100 85% identity
# Vollenhovia emeryi T-lymphocyte activation antigen CD86-like 3e-12 88% identity


# bed file of the 46 SNPs
cp ../2019-03-08-109samples-maf10percent/2020-08-25-forty-six-sig.BED  input/.

# there is no unique M region close to 46 SNPs
bedtools intersect \
				   -a tmp/unique_M_regions.merged.BED \
				   -b input/2020-08-25-forty-six-sig.BED \
				   > tmp/intersect_46_SNPs-unique_M_regions.BED


wc -l tmp/intersect_46_SNPs-unique_M_regions.BED

# combined result for the 13 longest regions with all M samples mapping to it but no P samples
contig-start-end-length-blast.txt

