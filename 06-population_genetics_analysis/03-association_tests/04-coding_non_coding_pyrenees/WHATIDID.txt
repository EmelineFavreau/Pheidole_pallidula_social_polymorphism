#!/bin/sh

###############################################################################
### Aims ###
Using only coding regions of the MinION assembly, focus on variants that could be linked the social organisation. In Pyrenees.
Two forks: one with LD pruning and one without.

###############################################################################
### Project preparation ###
module load bcftools/1.8
module load vcftools/0.1.15
module load R/3.5.1
# tabix 0.2.5
module load plink/1.9-170906


cp -a 2019-04-08-coding-only-pyrennees-maf10percent 2019-04-08-coding-only-pyrennees-maf10percent
cd 2019-04-08-coding-only-pyrennees-maf10percent


mkdir input

cd input

# copy vcf that has been filtered:
# 75% sample support
# biallelic SNPs
# phred quality > 30
# 109 samples (outliers removed)
# and contains only coding regions
ln -s ~/2019-03-18-filter_PpalE_genic_regions/result/intersected.vcf .

cd ..

mkdir result

mkdir -p ~/scratch/2019-03-05-association_analysis_flye_assembly/2019-04-08-coding-only-pyrennees-maf10percent

ln -s ~/scratch/2019-03-05-association_analysis_flye_assembly/2019-04-08-coding-only-pyrennees-maf10percent tmp

mkdir -p ~/archive/2019-03-05-association_analysis_flye_assembly/2019-04-08-coding-only-pyrennees-maf10percent

# copy important files
cp ~/2018-11-09-association_analysis_mixed_assembly/result/2019-02-06-109samples-maf10percent/pheno.txt .

cp ~/2018-11-09-association_analysis_mixed_assembly/result/2019-02-06-109samples-maf10percent/exploring-pca-results.Rmd .

cp ~/2018-11-09-association_analysis_mixed_assembly/result/2019-02-06-109samples-maf10percent/input/S2_pheidole_pop_paper.csv .

cp ~/2018-11-09-association_analysis_mixed_assembly/result/2019-02-06-109samples-maf10percent/assoc-analysis.Rmd .

cp ~/2019-03-18-filter_PpalE_genic_regions/result/non_genic_contig_names .

cp ~/2019-03-18-filter_PpalE_genic_regions/intersected.contig.length .


todayanalysis="2019-04-08-flye-pyrennees-genic"

###############################################################################
### Analysis


## Keep only samples from Pyrennees
cat S2_pheidole_pop_paper.csv | grep -E "Pyrenees" | cut -d "," -f 1 > pyrenees-colonies.txt


### Subsetting for only Pyrennees ###

vcftools --vcf input/intersected.vcf \
         --keep pyrenees-colonies.txt \
         --maf 0.05 \
         --recode \
         --recode-INFO-all \
         --out tmp/${todayanalysis}
# kept 14 out of 108 Individuals
# 71052 out of a possible 113234 Sites
# 21 seconds

cp tmp/${todayanalysis}.recode.vcf result/.

### Checking VCF stats ###

# Step 1: get sample names
bcftools query -l tmp/${todayanalysis}.recode.vcf \
              > tmp/${todayanalysis}-sample_names.txt

# get number of variants per contig
grep -v "^#" tmp/${todayanalysis}.recode.vcf | cut -f 1 | sort | uniq -c > ${todayanalysis}-snp-per-contig.txt


# copy to archive

rsync -avx --human-readable --progress tmp/${todayanalysis}.recode.vcf ~/archive/2019-03-05-association_analysis_flye_assembly/2019-04-08-coding-only-pyrennees-maf10percent/.

rsync -avx --human-readable --progress tmp/${todayanalysis}-sample_names.txt ~/archive/2019-03-05-association_analysis_flye_assembly/2019-04-08-coding-only-pyrennees-maf10percent/.

# softlink to result

cd result

ln -s ~/archive/2019-03-05-association_analysis_flye_assembly/2019-04-08-coding-only-pyrennees-maf10percent/${todayanalysis}.recode.vcf .

ln -s ~/archive/2019-03-05-association_analysis_flye_assembly/2019-04-08-coding-only-pyrennees-maf10percent/${todayanalysis}-sample_names.txt .

cd ..

###############################################################################
###############################################################################
Fork one: with LD pruning.
###############################################################################
## Prune away LD SNPs ##


# Step 1: assign chromosome-and-position-based IDs (currently not named)
plink --vcf result/${todayanalysis}.recode.vcf \
      --allow-extra-chr \
      --allow-no-sex \
      --pheno pheno.txt \
      --set-missing-var-ids @:#\$1,\$2 \
      --make-bed \
      --out tmp/${todayanalysis}-id

plink --bfile tmp/${todayanalysis}-id \
      --allow-extra-chr \
      --allow-no-sex \
      --pheno pheno.txt \
      --recode vcf \
      --out result/${todayanalysis}-id      

# Step 2: pruning away SNPs in LD
# people seem to use 0.2 as a threshold
# 88,906 of 113,234 variants removed
# [coding&noncoding: 522,460 of 808,475 variants removed]
plink --bfile tmp/${todayanalysis}-id \
      --allow-extra-chr \
      --allow-no-sex \
      --indep-pairwise 50 5 0.2 \
      --out tmp/${todayanalysis}-snp-in-ld

cp tmp/${todayanalysis}-snp-in-ld.prune.in result/.

# Step 3: filter data by keeping only the SNPs that are not in disequilibrium
# 24328 variants
# [coding&noncoding: 286,015 variants kept and 108 people]
plink --bfile tmp/${todayanalysis}-id \
      --allow-extra-chr \
      --allow-no-sex \
      --pheno pheno.txt \
      --extract tmp/${todayanalysis}-snp-in-ld.prune.in \
      --make-bed \
      --out tmp/${todayanalysis}-pruned-data

cp tmp/${todayanalysis}-pruned-data.bim result/. ;
cp tmp/${todayanalysis}-pruned-data.bed result/. ;
cp tmp/${todayanalysis}-pruned-data.fam result/.



###############################################################################
## PCA analysis ##

# Step 1:  create a genome file - IBD will be calculated
plink --bfile result/${todayanalysis}-pruned-data \
      --allow-extra-chr \
      --allow-no-sex \
      --pheno pheno.txt \
      --genome \
      --extract result/${todayanalysis}-snp-in-ld.prune.in \
      --out tmp/${todayanalysis}-IBD

# Step 2: generate an eigenvec file containing PCs
# header adds a header line to the .eigenvec file(s)
# --cluster uses IBS values calculated to perform complete linkage clustering
# .cluster2 describes only the final cluster configuration
plink --bfile result/${todayanalysis}-pruned-data \
      --allow-extra-chr \
      --allow-no-sex \
      --pheno pheno.txt \
      --cluster \
      --pca header \
      --extract result/${todayanalysis}-snp-in-ld.prune.in \
      --read-genome tmp/${todayanalysis}-IBD.genome \
      --out tmp/${todayanalysis}-PCA

# Step 3: output a VCF and make a SNP matrix
plink --bfile result/${todayanalysis}-pruned-data \
      --allow-extra-chr \
      --allow-no-sex \
      --pheno pheno.txt \
      --recode vcf \
      --out tmp/${todayanalysis}-pruned

# get SNP matrix and sample list
bcftools query tmp/${todayanalysis}-pruned.vcf -f '%ID\t%POS[\t%GT]\n' > tmp/${todayanalysis}-pruned-snp_matrix.txt

bcftools query --list-samples tmp/${todayanalysis}-pruned.vcf > result/${todayanalysis}-sample_list

cp tmp/${todayanalysis}-PCA* result/. ;
cp tmp/${todayanalysis}-pruned-snp_matrix.txt result/.

# make sense of the pca eigenvalue and ultimately
# how much of the variance is explained by each PC? PC1 1%, PC2 1%
Rscript exploring-pca-results.Rmd


###############################################################################
## run association test ##

# Step 1: Perform the association analysis using 2 main PCs
# from the eigenvec file as covariates
# covariate can only be used with a regression model, here logistics --logistic
plink --bfile result/${todayanalysis}-pruned-data \
      --allow-extra-chr \
      --allow-no-sex \
      --pheno pheno.txt \
      --covar result/2019-04-04-flye-italy-genic-eigenvec.tops.csv \
      --covar-name PC1,PC2 \
      --logistic \
      --out tmp/${todayanalysis}-LDpruned-maf0.05-snp-pvalues

# Step 2: understanding the output of the model
# ADD means the additive effects of allele dosage (counts of each allele)
# the direction of the regression coefficient represents
# the effect of each extra minor allele
# (i.e. a positive regression coefficient means that
# the minor allele increases risk/phenotype mean
# PLINK will also output the beta-coefficients for the adjustment variables
# that is why there are more lines than SNPs: 164212
wc -l tmp/${todayanalysis}-LDpruned-maf0.05-snp-pvalues.assoc.logistic

# remove the lines about PC1 and PC2
grep ADD tmp/${todayanalysis}-LDpruned-maf0.05-snp-pvalues.assoc.logistic > \
 tmp/${todayanalysis}-LDpruned-maf0.05-snp-pvalues.assoc.logistic.filtered

# count the number of variants left: 24,328 SNPs
wc -l tmp/${todayanalysis}-LDpruned-maf0.05-snp-pvalues.assoc.logistic.filtered

# Step 3: try a simple fisher test
# standard case/control association analysis using Fisher's exact test to generate significance
plink --bfile result/${todayanalysis}-pruned-data \
      --allow-extra-chr \
      --allow-no-sex \
      --pheno pheno.txt \
      --assoc fisher \
      --out tmp/${todayanalysis}

# copy to result
cp tmp/${todayanalysis}-LDpruned-maf0.05-snp-pvalues.assoc.logistic.filtered result/. ;
cp tmp/${todayanalysis}.assoc.fisher result/.


###############################################################################
## Association analysis ##

# adjusting p-values from plink output
# association test on each SNP for allele count per gyny group
Rscript assoc-analysis.Rmd
Rscript make-man.R















###############################################################################
###############################################################################
Fork two: without LD pruning.
###############################################################################
## prepare files ##
todayanalysis="2019-03-25-flye-Pheidole-genic-noLD"

# assign chromosome-and-position-based IDs (currently not named)
plink --vcf result/intersected.vcf \
      --allow-extra-chr \
      --allow-no-sex \
      --pheno pheno.txt \
      --set-missing-var-ids @:#\$1,\$2 \
      --make-bed \
      --out tmp/${todayanalysis}-id

cp tmp/${todayanalysis}-id.bim result/.; \
cp tmp/${todayanalysis}-id.bed result/.; \
cp tmp/${todayanalysis}-id.fam result/.



###############################################################################
## PCA analysis ##

# step 1 - create a genome file - IBD will be calculated
plink --bfile result/${todayanalysis}-id \
      --allow-extra-chr \
      --allow-no-sex \
      --pheno pheno.txt \
      --genome \
      --out tmp/${todayanalysis}-IBD

# step 2 - generate an eigenvec file containing PCs
# header adds a header line to the .eigenvec file(s)
# --cluster uses IBS values calculated to perform complete linkage clustering
# .cluster2 describes only the final cluster configuration
plink --bfile result/${todayanalysis}-id \
      --allow-extra-chr \
      --allow-no-sex \
      --pheno pheno.txt \
      --cluster \
      --pca header \
      --read-genome tmp/${todayanalysis}-IBD.genome \
      --out tmp/${todayanalysis}-PCA

cp tmp/${todayanalysis}-PCA* result/.

# make sense of the PCA eigenvalue and ultimately
# how much of the variance is explained by each PC? PC1 8%, PC2 3%
cp exploring-pca-results.Rmd exploring-pca-no-ld-results.Rmd
Rscript exploring-pca-results.Rmd


###############################################################################
## run association test ##

# Step 1: Perform the association analysis using 2 main PCs
# from the eigenvec file as covariates
# covariate can only be used with a regression model, here logistics --logistic
plink --bfile result/${todayanalysis}-id \
      --allow-extra-chr \
      --allow-no-sex \
      --pheno pheno.txt \
      --covar result/2019-03-23-flye-Pheidole-genic-noLDpruning-eigenvec.tops.csv \
      --covar-name PC1,PC2 \
      --logistic \
      --out tmp/${todayanalysis}-maf0.05-snp-pvalues

# Step 2: understanding the output of the model
# ADD means the additive effects of allele dosage (counts of each allele)
# the direction of the regression coefficient represents
# the effect of each extra minor allele
# (i.e. a positive regression coefficient means that
# the minor allele increases risk/phenotype mean
# PLINK will also output the beta-coefficients for the adjustment variables
# that is why there are more lines than SNPs: 339703
wc -l tmp/${todayanalysis}-maf0.05-snp-pvalues.assoc.logistic

# remove the lines about PC1 and PC2
grep ADD tmp/${todayanalysis}-maf0.05-snp-pvalues.assoc.logistic > \
 tmp/${todayanalysis}-maf0.05-snp-pvalues.assoc.logistic.filtered

# count the number of variants left: 113,234 SNPs
wc -l tmp/${todayanalysis}-maf0.05-snp-pvalues.assoc.logistic.filtered


# copy to result
cp tmp/${todayanalysis}-maf0.05-snp-pvalues.assoc.logistic.filtered result/.



###############################################################################
## Association analysis ##

# adjusting p-values from plink output
# association test on each SNP for allele count per gyny group
cp assoc-analysis.Rmd assoc-analysis-noLDpruning.Rmd
Rscript assoc-analysis.Rmd
Rscript make-man.R


###############################################################################
## FST sliding window analysis ##

# Step 1: make a new VCF
plink --bfile result/${todayanalysis}-id \
      --allow-extra-chr \
      --allow-no-sex \
      --recode vcf \
      --out tmp/${todayanalysis}

# Step 2: make text files with names of samples that are from M/P colonies
bcftools query --list-samples tmp/${todayanalysis}.vcf > ${todayanalysis}-sample_names.txt
grep -E "\-M" ${todayanalysis}-sample_names.txt > monogynous_sample_names.txt; \
grep -E "A56" ${todayanalysis}-sample_names.txt >> monogynous_sample_names.txt; \
grep -E "\-P" ${todayanalysis}-sample_names.txt > polygynous_sample_names.txt; \
grep -E "I27" ${todayanalysis}-sample_names.txt >> polygynous_sample_names.txt


# Step 3: calculate FST by window
# window size and step are based on Pracana 2017a
vcftools --vcf tmp/${todayanalysis}.vcf \
         --weir-fst-pop monogynous_sample_names.txt \
         --weir-fst-pop polygynous_sample_names.txt \
         --fst-window-size 30 \
         --fst-window-step 10 \
         --out tmp/${todayanalysis}-Mpop_vs_Ppop

# Step 4: evaluate investigate results
# number of windows: 292198
wc -l tmp/2019-03-25-flye-Pheidole-genic-noLD-Mpop_vs_Ppop.windowed.weir.fst
# check the range of weighted FST ($5)
# (equation 6 in Weir and Cockerham 1984 paper)
# used to combine info over alleles and loci
cp ~/2018-11-09-association_analysis_mixed_assembly/result/2019-02-14-fst_on_109samples/2019-02-14_fst_pavlue_comparison.Rmd 2019-03-29_fst_pvalue_comparison.Rmd
# right now there are not much correlation between
# fst values and p values from the regression analysis
