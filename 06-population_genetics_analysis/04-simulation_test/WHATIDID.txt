#!/bin/sh

###############################################################################
### Aims ###
Using only coding regions of the MinION assembly, focus on variants that could be linked the social organisation. Add a fake SNP and see if I can detect it.

###############################################################################
### Project preparation ###
module load bcftools/1.8
module load vcftools/0.1.15
module load R/3.5.1
# tabix 0.2.5
module load plink/1.9-170906


cp -a 2019-03-19-coding-only-109samples-maf10percent 2019-04-02-addfakesnp
cd 2019-04-02-addfakesnp

mkdir input

cd input

# copy vcf that has been filtered:
# 75% sample support
# biallelic SNPs
# phred quality > 30
# 109 samples (outliers removed)
# and contains only coding regions
ln -s ~/2019-03-18-filter_PpalE_genic_regions/result/intersected.vcf .
cd ..

mkdir result

mkdir -p ~/monthly_autoScratch/2019-03-05-association_analysis_flye_assembly/2019-03-08-109samples-maf10percent

ln -s ~/monthly_autoScratch/2019-03-05-association_analysis_flye_assembly/2019-03-08-109samples-maf10percent tmp

mkdir -p ~/archive/2019-03-05-association_analysis_flye_assembly/2019-04-02-addfakesnp

# copy important files
cp ~/2018-11-09-association_analysis_mixed_assembly/result/2019-02-06-109samples-maf10percent/pheno.txt .

cp ~/2018-11-09-association_analysis_mixed_assembly/result/2019-02-06-109samples-maf10percent/exploring-pca-results.Rmd .

cp ~/2018-11-09-association_analysis_mixed_assembly/result/2019-02-06-109samples-maf10percent/input/S2_pheidole_pop_paper.csv .

cp ~/2018-11-09-association_analysis_mixed_assembly/result/2019-02-06-109samples-maf10percent/assoc-analysis.Rmd .

cp ~/2019-03-18-filter_PpalE_genic_regions/result/non_genic_contig_names .

cp ~/2019-03-18-filter_PpalE_genic_regions/intersected.contig.length .

todayanalysis="2019-04-02-flye-Pheidole-genic-fakesnp"

################################################################################
# Add a SNP to the vcf file with the conditions:


# Step 1: create a realistic SNP
# monogynous are 0/0
# polygynous are 1/1
# is the analysis picking this SNP in the Manhattan plot?
# copy one SNP from VF to new file and change the name of contig
bcftools view -H input/intersected.vcf | head -1 | sed 's/contig_1_pilon_pilon_pilon_pilon_pilon_pilon_pilon_pilon_pilon_pilon/contig_0_pilon_pilon_pilon_pilon_pilon_pilon_pilon_pilon_pilon_pilon/' > fakeSNP

# remove the top 9 lines (not genotype info)
sed -r 's/\t/\n/g' fakeSNP | tail -n 108 > fakeSNP-gt_only

# get the sample names
bcftools query -l input/intersected.vcf > sample_names.txt

# change only the GT of poly for 1/1
Rscript make-fake-snp.Rmd

# reformat the snp info into VCF
cut -f 1,2,3,4,5,6,7,8,9 fakeSNP | paste - fakeSNP-gt_only-updated > fakeSNP_updated

# add new SNP and all real SNP to a new VCF file
cat input/intersected.vcf fakeSNP_updated > tmp/intersected_with-fakeSNP.vcf

# This vcf is ready to be analysed the same way as before
# to see if I can pick up the signal or not

# Step 2: create a realistic SNP
# monogynous are 0/0
# polygynous are 0/1
# is the analysis picking this SNP in the Manhattan plot?
# copy one SNP from VF to new file and change the name of contig
bcftools view -H input/intersected.vcf | head -1 | sed 's/contig_1_pilon_pilon_pilon_pilon_pilon_pilon_pilon_pilon_pilon_pilon/contig_01_pilon_pilon_pilon_pilon_pilon_pilon_pilon_pilon_pilon_pilon/' > fakeSNPhomhet

# remove the top 9 lines (not genotype info)
sed -r 's/\t/\n/g' fakeSNPhomhet | tail -n 108 > fakeSNPhomhet-gt_only

# get the sample names
bcftools query -l input/intersected.vcf > sample_names.txt

# change only the GT of poly for 1/1
cp make-fake-snp.Rmd make-fake-homhet-snp.Rmd
Rscript make-fake-homhet-snp.Rmd

# reformat the snp info into VCF
cut -f 1,2,3,4,5,6,7,8,9 fakeSNP | paste - fakeSNPhomhet-gt_only-updated > fakeSNPhomhet_updated

# add new SNP and all real SNP to a new VCF file
cat input/intersected.vcf fakeSNPhomhet_updated > tmp/intersected_with-fakeSNPhomhet.vcf

# This vcf is ready to be analysed the same way as before
# to see if I can pick up the signal or not


### Checking vcf stats ###

# Step 1: calculate the number of variants left: 113235
# [coding&noncoding: 808475]
grep -v "^#" tmp/intersected_with-fakeSNP.vcf | wc -l

# get number of variants per contig
grep -v "^#" tmp/intersected_with-fakeSNP.vcf | cut -f 1 | sort | uniq -c > ${todayanalysis}-snp-per-contig.txt


# copy to archive

rsync -avx --human-readable --progress tmp/intersected_with-fakeSNP.vcf ~/archive/2019-03-05-association_analysis_flye_assembly/2019-04-02-addfakesnp/.


rsync -avx --human-readable --progress sample_names.txt ~/archive/2019-03-05-association_analysis_flye_assembly/2019-04-02-addfakesnp/.


# softlink to result

cd result

ln -s ~/archive/2019-03-05-association_analysis_flye_assembly/2019-04-02-addfakesnp/intersected_with-fakeSNP.vcf .

ln -s ~/archive/2019-03-05-association_analysis_flye_assembly/2019-04-02-addfakesnp/sample_names.txt .

cd ..

###############################################################################
###############################################################################
Fork one: with LD pruning.
###############################################################################
## Prune away LD SNPs ##


# step 1 assign chromosome-and-position-based IDs (currently not named)
plink --vcf result/intersected_with-fakeSNP.vcf \
      --allow-extra-chr \
      --allow-no-sex \
      --pheno pheno.txt \
      --set-missing-var-ids @:#\$1,\$2 \
      --make-bed \
      --out tmp/${todayanalysis}-id

# step 2 - pruning away SNPs in LD
# people seem to use 0.2 as a threshold
# 58,497 of 113,234 variants removed
# [coding&noncoding: 522,460 of 808,475 variants removed]
plink --bfile tmp/${todayanalysis}-id \
      --allow-extra-chr \
      --allow-no-sex \
      --indep-pairwise 50 5 0.2 \
      --out tmp/${todayanalysis}-snp-in-ld

cp tmp/${todayanalysis}-snp-in-ld.prune.in result/.

# step 3 - filter data by keeping only the SNPs that are not in disequilibrium
# 54,737 variants and 108
# [coding&noncoding: 286,015 variants kept and 108 people]
plink --bfile tmp/${todayanalysis}-id \
      --allow-extra-chr \
      --allow-no-sex \
      --pheno pheno.txt \
      --extract tmp/${todayanalysis}-snp-in-ld.prune.in \
      --make-bed \
      --out tmp/${todayanalysis}-pruned-data

cp tmp/${todayanalysis}-pruned-data.bim result/. ;
cp tmp/${todayanalysis}-pruned-data.bed result/. ;
cp tmp/${todayanalysis}-pruned-data.fam result/.



###############################################################################
## PCA analysis ##

# step 1 - create a genome file - IBD will be calculated
plink --bfile result/${todayanalysis}-pruned-data \
      --allow-extra-chr \
      --allow-no-sex \
      --pheno pheno.txt \
      --genome \
      --extract result/${todayanalysis}-snp-in-ld.prune.in \
      --out tmp/${todayanalysis}-IBD

# step 2 - generate an eigenvec file containing PCs
# header adds a header line to the .eigenvec file(s)
# --cluster uses IBS values calculated to perform complete linkage clustering
# .cluster2 describes only the final cluster configuration
plink --bfile result/${todayanalysis}-pruned-data \
      --allow-extra-chr \
      --allow-no-sex \
      --pheno pheno.txt \
      --cluster \
      --pca header \
      --extract result/${todayanalysis}-snp-in-ld.prune.in \
      --read-genome tmp/${todayanalysis}-IBD.genome \
      --out tmp/${todayanalysis}-PCA

cp tmp/${todayanalysis}-PCA* result/.

# make sense of the pca eigenvalue and ultimately
# how much of the variance is explained by each PC?
# No change when adding one extra snp
Rscript exploring-pca-results.Rmd


###############################################################################
## run association test ##

# Step 1: Perform the association analysis using 2 main PCs
# from the eigenvec file as covariates
# covariate can only be used with a regression model, here logistics --logistic
plink --bfile result/${todayanalysis}-pruned-data \
      --allow-extra-chr \
      --allow-no-sex \
      --pheno pheno.txt \
      --covar result/2019-04-02-flye-Pheidole-genic-fakesnp-eigenvec.tops.csv \
      --covar-name PC1,PC2 \
      --logistic \
      --out tmp/${todayanalysis}-LDpruned-maf0.05-snp-pvalues

# Step 2: understanding the output of the model
# ADD means the additive effects of allele dosage (counts of each allele)
# the direction of the regression coefficient represents
# the effect of each extra minor allele
# (i.e. a positive regression coefficient means that
# the minor allele increases risk/phenotype mean
# PLINK will also output the beta-coefficients for the adjustment variables
# that is why there are more lines than SNPs: 164215
wc -l tmp/${todayanalysis}-LDpruned-maf0.05-snp-pvalues.assoc.logistic

# remove the lines about PC1 and PC2
grep ADD tmp/${todayanalysis}-LDpruned-maf0.05-snp-pvalues.assoc.logistic > \
 tmp/${todayanalysis}-LDpruned-maf0.05-snp-pvalues.assoc.logistic.filtered

# count the number of variants left: 54,38 SNPs
wc -l tmp/${todayanalysis}-LDpruned-maf0.05-snp-pvalues.assoc.logistic.filtered

# Step 3: try a simple fisher test
# standard case/control association analysis using Fisher's exact test to generate significance
plink --bfile result/${todayanalysis}-pruned-data \
      --allow-extra-chr \
      --allow-no-sex \
      --pheno pheno.txt \
      --assoc fisher \
      --out tmp/${todayanalysis}

# copy to result
cp tmp/${todayanalysis}-LDpruned-maf0.05-snp-pvalues.assoc.logistic.filtered result/.
cp tmp/${todayanalysis}.assoc.fisher result/.


###############################################################################
## Association analysis ##

# adjusting p-values from plink output
# association test on each SNP for allele count per gyny group
Rscript assoc-analysis.Rmd






todayanalysis="2019-04-02-flye-Bruniquel-genic-fakesnp"
###############################################################################
### Subset for Bruniquel only ###

cp ~/2019-03-05-association_analysis_flye_assembly/result/2019-03-14-bruniquel-maf10percent/bruniquel-colonies.txt .

vcftools --vcf tmp/intersected_with-fakeSNP.vcf \
         --keep bruniquel-colonies.txt \
         --recode \
         --recode-INFO-all \
         --out tmp/${todayanalysis}
# kept 68 out of 108 Individuals
# 113234 out of a possible 113234 Sites
# 46 seconds


###############################################################################
### Prune away LD SNPs ##


# step 1 assign chromosome-and-position-based IDs (currently not named)
plink --vcf tmp/${todayanalysis}.recode.vcf \
      --allow-extra-chr \
      --allow-no-sex \
      --pheno pheno.txt \
      --set-missing-var-ids @:#\$1,\$2 \
      --make-bed \
      --out tmp/${todayanalysis}-id

# step 2 - pruning away SNPs in LD
# people seem to use 0.2 as a threshold
# 57,613 of 113,235 variants removed
# [coding&noncoding: 522,460 of 808,475 variants removed]
plink --bfile tmp/${todayanalysis}-id \
      --allow-extra-chr \
      --allow-no-sex \
      --indep-pairwise 50 5 0.2 \
      --out tmp/${todayanalysis}-snp-in-ld

cp tmp/${todayanalysis}-snp-in-ld.prune.in result/.

# step 3 - filter data by keeping only the SNPs that are not in disequilibrium
# 54,737 variants and 108
# [coding&noncoding: 286,015 variants kept and 108 people]
plink --bfile tmp/${todayanalysis}-id \
      --allow-extra-chr \
      --allow-no-sex \
      --pheno pheno.txt \
      --extract tmp/${todayanalysis}-snp-in-ld.prune.in \
      --make-bed \
      --out tmp/${todayanalysis}-pruned-data

cp tmp/${todayanalysis}-pruned-data.bim result/. ;
cp tmp/${todayanalysis}-pruned-data.bed result/. ;
cp tmp/${todayanalysis}-pruned-data.fam result/.



###############################################################################
## PCA analysis ##

# step 1 - create a genome file - IBD will be calculated
plink --bfile result/${todayanalysis}-pruned-data \
      --allow-extra-chr \
      --allow-no-sex \
      --pheno pheno.txt \
      --genome \
      --extract result/${todayanalysis}-snp-in-ld.prune.in \
      --out tmp/${todayanalysis}-IBD

# step 2 - generate an eigenvec file containing PCs
# header adds a header line to the .eigenvec file(s)
# --cluster uses IBS values calculated to perform complete linkage clustering
# .cluster2 describes only the final cluster configuration
plink --bfile result/${todayanalysis}-pruned-data \
      --allow-extra-chr \
      --allow-no-sex \
      --pheno pheno.txt \
      --cluster \
      --pca header \
      --extract result/${todayanalysis}-snp-in-ld.prune.in \
      --read-genome tmp/${todayanalysis}-IBD.genome \
      --out tmp/${todayanalysis}-PCA

cp tmp/${todayanalysis}-PCA* result/.

# make sense of the pca eigenvalue and ultimately
# how much of the variance is explained by each PC?
# No change when adding one extra snp
cp exploring-pca-results.Rmd Bruniquel-exploring-pca-results.Rmd
Rscript Bruniquel-exploring-pca-results.Rmd


###############################################################################
## run association test ##

# Step 1: Perform the association analysis using 2 main PCs
# from the eigenvec file as covariates
# covariate can only be used with a regression model, here logistics --logistic
plink --bfile result/${todayanalysis}-pruned-data \
      --allow-extra-chr \
      --allow-no-sex \
      --pheno pheno.txt \
      --covar result/2019-04-02-flye-Bruniquel-genic-fakesnp-eigenvec.tops.csv \
      --covar-name PC1,PC2 \
      --logistic \
      --out tmp/${todayanalysis}-LDpruned-maf0.05-snp-pvalues

# Step 2: understanding the output of the model
# ADD means the additive effects of allele dosage (counts of each allele)
# the direction of the regression coefficient represents
# the effect of each extra minor allele
# (i.e. a positive regression coefficient means that
# the minor allele increases risk/phenotype mean
# PLINK will also output the beta-coefficients for the adjustment variables
# that is why there are more lines than SNPs: 166867
wc -l tmp/${todayanalysis}-LDpruned-maf0.05-snp-pvalues.assoc.logistic

# remove the lines about PC1 and PC2
grep ADD tmp/${todayanalysis}-LDpruned-maf0.05-snp-pvalues.assoc.logistic > \
 tmp/${todayanalysis}-LDpruned-maf0.05-snp-pvalues.assoc.logistic.filtered

# count the number of variants left: 55,622 SNPs
wc -l tmp/${todayanalysis}-LDpruned-maf0.05-snp-pvalues.assoc.logistic.filtered

# Step 3: try a simple fisher test
# standard case/control association analysis using Fisher's exact test to generate significance
plink --bfile result/${todayanalysis}-pruned-data \
      --allow-extra-chr \
      --allow-no-sex \
      --pheno pheno.txt \
      --assoc fisher \
      --out tmp/${todayanalysis}

# copy to result
cp tmp/${todayanalysis}-LDpruned-maf0.05-snp-pvalues.assoc.logistic.filtered result/.
cp tmp/${todayanalysis}.assoc.fisher result/.


###############################################################################
## Association analysis ##

# adjusting p-values from plink output
# association test on each SNP for allele count per gyny group
cp assoc-analysis.Rmd Bruniquel-assoc-analysis.Rmd
Rscript Bruniquel-assoc-analysis.Rmd
